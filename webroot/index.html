<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/libs/flot/jquery.flot.js"></script>

  </head>
  <body>
    
  
    <input type="text" id="command" /> <button onclick="game.send('echo', $('#command').val());"> echo </button>
    
    
    <p>Ping: <input type="text" id="ping" value="n/a"> seconds</p>

    <script type="text/javascript">

      function microtime (get_as_float) {
          // Returns either a string or a float containing the current time in seconds and microseconds  
          // 
          // version: 1109.2015
          // discuss at: http://phpjs.org/functions/microtime
          // +   original by: Paulo Freitas
          // *     example 1: timeStamp = microtime(true);
          // *     results 1: timeStamp > 1000000000 && timeStamp < 2000000000
          var now = new Date().getTime() / 1000;
          var s = parseInt(now, 10);
       
          return (get_as_float) ? now : (Math.round((now - s) * 1000) / 1000) + ' ' + s;
      }    
      
      
      var PingAverager = function() {
          this._limit = 10;
          this._counts = [];
          for(var i = 0; i < this._limit; i++) this._counts.push(0);
          this._running = 0;
          this._offset = 0;
          return this;
      }
      
      PingAverager.prototype.log = function(ping) {
          this._running -= this._counts[this._offset];
          this._counts[this._offset] = ping;
          this._offset = (this._offset + 1) % this._limit;
          this._running += ping;
      }
      
      PingAverager.prototype.get = function() {
          if (this._counts.length == 0) return 0;
          return this._running / this._counts.length;
      }
    
      var G_SERVER = "http://ec2-176-34-197-62.eu-west-1.compute.amazonaws.com:8080/";

      /**************************************************
       * General / Init
       **************************************************/

      var Game = function(fps, pingElement) {
        this.fps = fps;
        this._interval = undefined;
        this._socket = undefined;
        
        this._ping = new PingAverager();
        
        this._ui = {
          'pingElement': pingElement, 
        };
        
        return this;
      };

      Game.prototype.start = function() {
        if (!this.connect()) return false;
      
        if (this._interval == undefined) {
          this._interval = setInterval($.proxy(this.run, this), 1000 / this.fps)
        }
        
        return this._interval != undefined;
      };
      
      Game.prototype.run = function() {
        this.updateGame();
        this.updateUi();
      } 
      
      Game.prototype.updateGame = function() {
        this.send("ping", microtime(true));
      }
      
      Game.prototype.updateUi = function() {
      }

      
      /**************************************************
       * Network Stuff
       **************************************************/             
      Game.prototype.connect = function() {
        if (this._socket) return false;
        
        this._socket = io.connect(G_SERVER);
        this._socket.on("responder", $.proxy(this.onResponder, this));
        this._socket.on("pong", $.proxy(this.onPong, this));
        
        return true;
      };
      
      Game.prototype.onResponder = function(data) {
      };
      
      Game.prototype.onPong = function(data) {
        var now = microtime(true);
        var ping = now - data.data;
        
         this._ping.log(ping);
        
        this.setDisplayedPing(this._ping.get());
        
        
        //console.log("lag,lat (" + (now - data.data) + "," + (now - data.time) + ")");
      };

      Game.prototype.send = function(command, data) {
        this._socket.emit(command, data);
      };
      

      /**************************************************
       * UI 
       **************************************************/      
      
      Game.prototype.setDisplayedPing = function(ping) {
        this._ui.pingElement.val(ping);
      }
      
      
      var game = new Game(20, $('#ping'));
      game.start();
      
    </script>

</body>

                           